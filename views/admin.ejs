<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="./css/admin.css" />

</head>
<body>

<div id="upload-popup">
  <div class="upload-popup-content">
    <h3 id="popup-title" class="upload-popup-text">Subiendo archivo...</h3>
    <p id="popup-message" class="upload-popup-menssage">Por favor espera un momento.</p>
    <div id="popup-progress" class="upload-popup-progress">
      <div class="upload-popup-bar" style="width: 0%;"></div>
    </div>
    <button id="popup-close" class="upload-popup-btn-close">Cerrar</button>
  </div>
</div>

  <h1>Panel de Administración</h1>

  <!-- =================== -->
  <!-- CRUD PRODUCTOS -->
  <!-- =================== -->
  <section>
    <h2>Productos</h2>
    <button class="add-btn" onclick="openModal('producto')">➕ Agregar Producto</button>
    <table id="tabla-productos">
      <thead>
        <tr><th>ID</th><th>Nombre</th><th>Descripción</th><th>Imagen</th><th>Acciones</th></tr>
      </thead>
      <tbody>
        <% productos.forEach(p => { %>
          <tr>
            <td><%= p.id %></td>
            <td><%= p.name %></td>
            <td><%= p.description %></td>
            <td><img src="<%= p.imageUrl %>" width="80"></td>
            <td>
              <button class="edit-btn" onclick='editProducto(<%= JSON.stringify(p) %>)'>Editar</button>
              <button class="del-btn" onclick='deleteProducto("<%= p.id %>")'>Eliminar</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Modal Productos -->
  <div class="modal" id="modal-producto">
    <div class="modal-content">
      <span class="close" onclick="closeModal('producto')">✖</span>
      <h3 id="modal-title-producto">Agregar Producto</h3>
      <form id="form-producto">
        <input type="hidden" id="producto-id">
        <input type="text" id="producto-name" placeholder="Nombre" required><br><br>
        <input type="text" id="producto-description" placeholder="Descripción" required><br><br>
        <input type="url" id="producto-imageUrl" placeholder="URL Imagen" required><br><br>
        <button type="submit">Guardar</button>
      </form>
    </div>
  </div>

  <!-- =================== -->
  <!-- CRUD TESTIMONIOS -->
  <!-- =================== -->
  <section>
    <h2>Testimonios</h2>
    <button class="add-btn" onclick="openModal('testimonio')">➕ Agregar Testimonio</button>
    <table id="tabla-testimonios">
      <thead>
        <tr><th>ID</th><th>Nombre</th><th>Cita</th><th>Acciones</th></tr>
      </thead>
      <tbody>
        <% testimonios.forEach(t => { %>
          <tr>
            <td><%= t.id %></td>
            <td><%= t.name %></td>
            <td><%= t.quote %></td>
            <td>
              <button class="edit-btn" onclick='editTestimonio(<%= JSON.stringify(t) %>)'>Editar</button>
              <button class="del-btn" onclick='deleteTestimonio("<%= t.id %>")'>Eliminar</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Modal Testimonios -->
  <div class="modal" id="modal-testimonio">
    <div class="modal-content">
      <span class="close" onclick="closeModal('testimonio')">✖</span>
      <h3 id="modal-title-testimonio">Agregar Testimonio</h3>
      <form id="form-testimonio">
        <input type="hidden" id="testimonio-id">
        <input type="text" id="testimonio-name" placeholder="Nombre" required><br><br>
        <input type="text" id="testimonio-quote" placeholder="Cita" required><br><br>
        <button type="submit">Guardar</button>
      </form>
    </div>
  </div>

  <!-- =================== -->
  <!-- CRUD GALERIA -->
  <!-- =================== -->
  <section>
    <h2>Galería</h2>
    <button class="add-btn" onclick="openModal('galeria')">➕ Agregar a Galería</button>
    <table id="tabla-galeria">
      <thead>
        <tr><th>ID</th><th>Archivo</th><th>Descripción</th><th>Acciones</th></tr>
      </thead>
      <tbody>
        <% galeria.forEach(g => { %>
          <tr>
            <td><%= g.id %></td>
            <td>
              <% if (g.type === "image") { %>
                <img src="<%= g.fileUrl %>" width="100">
              <% } else if (g.type === "video") { %>
                <video src="<%= g.fileUrl %>" width="200" controls autoplay muted playsinline preload="auto"></video>
              <% } else if (g.type === "audio") { %>
                <audio src="<%= g.fileUrl %>" controls></audio>
              <% } %>
            </td>
            <td><%= g.description %></td>
            <td>
              <button class="edit-btn" onclick='editGaleria(<%= JSON.stringify(g) %>)'>Editar</button>
              <button class="del-btn" onclick='deleteGaleria("<%= g.id %>")'>Eliminar</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Modal Galería -->
  <div class="modal" id="modal-galeria">
    <div class="modal-content">
      <span class="close" onclick="closeModal('galeria')">✖</span>
      <h3 id="modal-title-galeria">Agregar a Galería</h3>
      <form id="form-galeria" enctype="multipart/form-data">
        <input type="hidden" id="galeria-id">
        <input type="file" id="galeria-file" accept="image/*,video/*,audio/*"><br><br>
        <input type="text" id="galeria-description" placeholder="Descripción" required><br><br>
        <button type="submit">Guardar</button>
      </form>
    </div>
  </div>

  <!-- POPUP MENSAJE -->
  <div class="popup-message" id="popup-msg"></div>

<script>
// =========================
// FUNCIONES GENÉRICAS
// =========================

// ================================
// Popup de carga / errores (nuevo)
// ================================
const popup = document.getElementById("upload-popup");
const popupTitle = document.getElementById("popup-title");
const popupMessage = document.getElementById("popup-message");
const popupProgressBar = document.querySelector(".upload-popup-bar");
const popupClose = document.getElementById("popup-close");

// Mostrar popup al iniciar carga
function showPopup(title = "Subiendo archivo...", message = "Por favor espera un momento.") {
  popupTitle.textContent = title;
  popupMessage.textContent = message;

  popup.classList.add("active");
  popup.classList.remove("success", "error");

  popupProgressBar.style.width = "0%";
  popupProgressBar.style.backgroundColor = "#2563eb";
  popupClose.style.display = "none";
}

// Actualizar progreso visual
function updateProgress(percent) {
  popupProgressBar.style.width = percent + "%";
}

// Mostrar error con color rojo y botón de cerrar
function showError(message = "Ocurrió un error al subir el archivo.") {
  popup.classList.add("active", "error");
  popupTitle.textContent = "Error al subir archivo ❌";
  popupMessage.textContent = message;
  popupProgressBar.style.backgroundColor = "#dc2626"; // rojo
  popupProgressBar.style.width = "100%";
  popupClose.style.display = "inline-block";
}

// Mostrar éxito con color verde
function showSuccess(message = "El archivo se ha subido correctamente.") {
  popup.classList.add("success");
  popupTitle.textContent = "Completado ✅";
  popupMessage.textContent = message;
  popupProgressBar.style.backgroundColor = "#16a34a"; // verde
  popupProgressBar.style.width = "100%";
  popupClose.style.display = "inline-block";
}

// Cerrar popup manualmente
popupClose.addEventListener("click", () => {
  popup.classList.remove("active", "success", "error");
});

// ================================
// Ejemplo de uso con Fetch y progreso
// ================================
// (Opcional: para integrar con tu subida real de galería)
async function uploadFile(file) {
  showPopup();

  const url = "/api/galeria/upload"; // ruta de tu endpoint
  const formData = new FormData();
  formData.append("file", file);

  const xhr = new XMLHttpRequest();
  xhr.open("POST", url, true);

  xhr.upload.onprogress = (e) => {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      updateProgress(percent);
    }
  };

  xhr.onload = () => {
    if (xhr.status === 200) {
      showSuccess("Archivo subido con éxito.");
    } else {
      showError("Error al subir: " + xhr.statusText);
    }
  };

  xhr.onerror = () => {
    showError("No se pudo conectar con el servidor.");
  };

  xhr.send(formData);
}





function showMessage(msg) {
  const popup = document.getElementById('popup-msg');
  popup.innerText = msg;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 2500);
}

const jsonHeaders = { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" };
const ajaxHeaders = { "X-Requested-With": "XMLHttpRequest", Accept: "application/json" };

const sanitizePublicId = name => `${Date.now()}-${name}`.replace(/\s+/g, "-").replace(/[^a-zA-Z0-9._-]/g, "");
const mapCloudinaryType = (resourceType, format = "") => {
  if (resourceType === "image") return "image";
  const audioFormats = ["mp3", "wav", "ogg", "aac", "m4a"];
  if (resourceType === "video" && audioFormats.includes(format?.toLowerCase())) return "audio";
  if (resourceType === "video") return "video";
  return "image";
};

function openModal(tipo, id = null) {
  document.getElementById(`modal-${tipo}`).style.display = 'flex';
  document.getElementById(`form-${tipo}`).reset();

  if (tipo === 'galeria') window.galeriaId = id;
  if (tipo === 'producto') window.productoId = id;
  if (tipo === 'testimonio') window.testimonioId = id;

  document.getElementById(`modal-title-${tipo}`).innerText =
    id ? `Editar ${tipo}` : `Agregar ${tipo}`;
}

function closeModal(tipo) {
  document.getElementById(`modal-${tipo}`).style.display = 'none';
  if (tipo === 'galeria') window.galeriaId = null;
  if (tipo === 'producto') window.productoId = null;
  if (tipo === 'testimonio') window.testimonioId = null;
}

// =========================
// PRODUCTOS
// =========================
document.getElementById('form-producto').addEventListener('submit', async e => {
  e.preventDefault();
  const id = window.productoId;
  const productoName = document.getElementById('producto-name');
  const productoDescription = document.getElementById('producto-description');
  const productoImageUrl = document.getElementById('producto-imageUrl');

  const data = {
    name: productoName.value,
    description: productoDescription.value,
    imageUrl: productoImageUrl.value
  };

  const url = id ? `/admin/edit/${id}` : '/admin/add';
  const res = await fetch(url, {
    method: 'POST',
    headers: jsonHeaders,
    body: JSON.stringify(data)
  });

  // Como el backend hace redirect, comprobamos si fue exitoso por status
  if (res.ok) {
    showMessage(id ? 'Producto actualizado' : 'Producto agregado');
    await updateProductos();
    closeModal('producto');
  } else {
    showMessage('Error al guardar producto');
  }
});

async function updateProductos() {
  const res = await fetch('/admin/products/list', { headers: ajaxHeaders });
  const productos = await res.json();
  const tbody = document.querySelector('#tabla-productos tbody');
  tbody.innerHTML = '';
  productos.forEach(p => {
    tbody.innerHTML += `
      <tr>
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${p.description}</td>
        <td><img src="${p.imageUrl}" width="80"></td>
        <td>
          <button class="edit-btn" onclick='editProducto(${JSON.stringify(p)})'>Editar</button>
          <button class="del-btn" onclick='deleteProducto("${p.id}")'>Eliminar</button>
        </td>
      </tr>`;
  });
}

function editProducto(p) {
  openModal('producto', p.id);
  document.getElementById('producto-name').value = p.name;
  document.getElementById('producto-description').value = p.description;
  document.getElementById('producto-imageUrl').value = p.imageUrl;
}

async function deleteProducto(id) {
  if (!confirm('¿Eliminar producto?')) return;
  const res = await fetch(`/admin/delete/${id}`, { method: 'POST', headers: ajaxHeaders });
  if (res.ok) {
    showMessage('Producto eliminado');
    updateProductos();
  } else {
    showMessage('Error al eliminar producto');
  }
}

// =========================
// TESTIMONIOS
// =========================
document.getElementById('form-testimonio').addEventListener('submit', async e => {
  e.preventDefault();
  const id = window.testimonioId;
  const testimonioName = document.getElementById('testimonio-name');
  const testimonioQuote = document.getElementById('testimonio-quote');

  const data = {
    name: testimonioName.value,
    quote: testimonioQuote.value
  };

  const url = id ? `/admin/testimonial/edit/${id}` : '/admin/testimonial/add';
  const res = await fetch(url, {
    method: 'POST',
    headers: jsonHeaders,
    body: JSON.stringify(data)
  });

  if (res.ok) {
    showMessage(id ? 'Testimonio actualizado' : 'Testimonio agregado');
    await updateTestimonios();
    closeModal('testimonio');
  } else {
    showMessage('Error al guardar testimonio');
  }
});

async function updateTestimonios() {
  const res = await fetch('/admin/testimonials/list', { headers: ajaxHeaders });
  const testimonios = await res.json();
  const tbody = document.querySelector('#tabla-testimonios tbody');
  tbody.innerHTML = '';
  testimonios.forEach(t => {
    tbody.innerHTML += `
      <tr>
        <td>${t.id}</td>
        <td>${t.name}</td>
        <td>${t.quote}</td>
        <td>
          <button class="edit-btn" onclick='editTestimonio(${JSON.stringify(t)})'>Editar</button>
          <button class="del-btn" onclick='deleteTestimonio("${t.id}")'>Eliminar</button>
        </td>
      </tr>`;
  });
}

function editTestimonio(t) {
  openModal('testimonio', t.id);
  document.getElementById('testimonio-name').value = t.name;
  document.getElementById('testimonio-quote').value = t.quote;
}

async function deleteTestimonio(id) {
  if (!confirm('¿Eliminar testimonio?')) return;
  const res = await fetch(`/admin/testimonial/delete/${id}`, { method: 'POST', headers: ajaxHeaders });
  if (res.ok) {
    showMessage('Testimonio eliminado');
    updateTestimonios();
  } else {
    showMessage('Error al eliminar testimonio');
  }
}

// =========================
// GALERÍA
// =========================
document.getElementById('form-galeria').addEventListener('submit', async e => {
  e.preventDefault();

  const id = galeriaId;
  const galeriaFile = document.getElementById('galeria-file');
  const galeriaDescription = document.getElementById('galeria-description');

  const file = galeriaFile.files[0];
  const description = galeriaDescription.value;

  // Mostrar popup de carga
  showPopup("Subiendo archivo...", "Por favor espera mientras se procesa el archivo.");

  try {
    let uploadData = null;

    if (file) {
      // 1) pedir firma
      const publicId = sanitizePublicId(file.name);
      const signRes = await fetch("/admin/gallery/sign", {
        method: "POST",
        headers: jsonHeaders,
        body: JSON.stringify({ publicId })
      });
      if (signRes.status === 401) {
        showError("Sesión expirada. Vuelve a iniciar sesión.");
        window.location.href = "/login";
        return;
      }
      if (!signRes.ok) throw new Error("No se pudo obtener firma de subida.");

      const signData = await signRes.json();
      const uploadUrl = `https://api.cloudinary.com/v1_1/${signData.cloudName}/auto/upload`;
      const uploadForm = new FormData();
      uploadForm.append("file", file);
      uploadForm.append("api_key", signData.apiKey);
      uploadForm.append("timestamp", signData.timestamp);
      uploadForm.append("signature", signData.signature);
      uploadForm.append("folder", signData.folder);
      uploadForm.append("public_id", publicId);

      // 2) subir directo a Cloudinary con progreso
      uploadData = await new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", uploadUrl);

        xhr.upload.addEventListener("progress", e => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            updateProgress(percent);
          }
        });

        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              resolve(JSON.parse(xhr.responseText));
            } catch (err) {
              reject(new Error("Respuesta inesperada de Cloudinary."));
            }
          } else {
            reject(new Error("Error de Cloudinary (" + xhr.status + ")."));
          }
        };

        xhr.onerror = () => reject(new Error("No se pudo conectar con Cloudinary."));

        xhr.send(uploadForm);
      });
    }

    if (!uploadData && !id) {
      throw new Error("Selecciona un archivo para subir.");
    }

    const payload = {
      description
    };

    if (uploadData) {
      payload.fileUrl = uploadData.secure_url;
      payload.publicId = uploadData.public_id;
      payload.resourceType = uploadData.resource_type;
      payload.format = uploadData.format;
      payload.type = mapCloudinaryType(uploadData.resource_type, uploadData.format);
    }

    const saveUrl = id ? `/admin/gallery/edit-direct/${id}` : "/admin/gallery/add-direct";
    const saveMethod = id ? "PUT" : "POST";

    const saveRes = await fetch(saveUrl, {
      method: saveMethod,
      headers: jsonHeaders,
      body: JSON.stringify(payload)
    });

    if (saveRes.status === 401) {
      showError("Sesión expirada. Vuelve a iniciar sesión.");
      window.location.href = "/login";
      return;
    }

    const saveData = await saveRes.json().catch(() => ({}));
    if (!saveRes.ok || !saveData?.success) {
      throw new Error(saveData?.message || "Error al guardar en la base de datos.");
    }

    showSuccess("Archivo subido correctamente.");
    updateGaleria(); // refresca tabla
    closeModal("galeria");
  } catch (err) {
    console.error(err);
    showError("Error inesperado: " + err.message);
  }
});


async function updateGaleria() {
  const res = await fetch('/admin/gallery/list', { headers: ajaxHeaders });
  const galeria = await res.json();
  const tbody = document.querySelector('#tabla-galeria tbody');
  tbody.innerHTML = '';
  galeria.forEach(g => {
    let media = '';
    if (g.type === 'image') media = `<img src="${g.fileUrl}" width="100">`;
    else if (g.type === 'video') media = `<video src="${g.fileUrl}" width="200" controls autoplay muted playsinline preload="auto"></video>`;
    else media = `<audio src="${g.fileUrl}" controls></audio>`;
    tbody.innerHTML += `
      <tr>
        <td>${g.id}</td>
        <td>${media}</td>
        <td>${g.description}</td>
        <td>
          <button class="edit-btn" onclick='editGaleria(${JSON.stringify(g)})'>Editar</button>
          <button class="del-btn" onclick='deleteGaleria("${g.id}")'>Eliminar</button>
        </td>
      </tr>`;
  });
}

function editGaleria(g) {
  openModal('galeria', g.id);
  document.getElementById('galeria-description').value = g.description;
}

async function deleteGaleria(id) {
  if (!confirm('¿Eliminar archivo?')) return;
  const res = await fetch(`/admin/gallery/delete/${id}`, { method: 'POST', headers: ajaxHeaders });
  if (res.ok) {
    showMessage('Archivo eliminado');
    updateGaleria();
  } else {
    showMessage('Error al eliminar archivo');
  }
}

// =========================
// ACTUALIZAR TODO AL INICIO
// =========================
window.addEventListener('DOMContentLoaded', () => {
  updateProductos();
  updateTestimonios();
  updateGaleria();
});
</script>




</body>
</html>
